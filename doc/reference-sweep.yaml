###########################################################################
# Reference sweep specification                                           #
###########################################################################
# This is the file format used as the input to configure a spectrum       #
# monitoring sweep executed by the `edge-sensor-sweep` script.            #
###########################################################################

# The following metadata is added as-is to attrs in each saved xarray Dataset
description:
  summary: Brief description of the capture

  # manual specification of GPS location coordinates
  # (in the future, automatic GPS location via gpsd may be implemented)
  location:
  - 39.991746624418745   # lat (deg)
  - -105.26457779333897   # long (deg)
  - 1783.4   # ASL (m)

  signal_chain:
  - Signal generator, 3710 MHz CW with 10 ms square pulse modulation

output:
  path: ~/Documents/data/{radio_id}/{start_time}.zarr.zip
  store: zip

  coord_aliases:
    antenna_name:
      # category names and dependent values
      reference:
        channel: 0
      lpda:
        channel: 1

# Radio setup parameters that apply to all captures
radio_setup:
  # python radio driver to use to connect to hardware
  # (must match a class name that subclasses edge_sensor.radio.RadioDevice)
  driver: Air7201B

  # sample timestamp source {"internal", "external"}
  time_source: internal

  # Acquisition start times will only occur at this fixed time modulus (s)
  # This can for example start all acquisitions at the same time within a
  # cellular frame.
  periodic_trigger: 10e-3

  # calibration data path
  # - if a relative path, it is interpreted as relative to this yaml
  # - if not specified, IQ is normalized as ADC full scale
  calibration: ../../calibrations/Air7201B-{radio_id}.p


# These settings are used unless specified otherwise for each capture
defaults:
  # RF Center frequency (Hz)
  center_frequency: 3710e6

  # Channel index, e.g., 0 -> RX1, 1 -> RX2
  channel: 0

  # hardware gain setting (dB)
  # Range is hardware-dependent - see the gain limits specified by
  #   src/edge_sensor/radio/*.py
  gain: -10 # dB

  # acquisition duration (s)
  duration: 0.5 

  # waveform sample rate (samples/s)
  sample_rate: 15.36e6

  # filter bandwidth
  analysis_bandwidth: 10e6

  # digitally shift the LO out of the acquisition band: 'left', 'right', 'none'
  lo_shift: none

  # whether to apply computation-intensive resampling on the host
  # from a divisor of the radio's master clock rate.
  #
  # if false, radio firmware will perform the resampling
  host_resample: true


# A list of dictionaries that specify the characteristics of the sweep captures to acquire.
# The sweep is executed by stepping each capture in order.
#
# The size of the `capture` dimension in the xarray Dataset output from `edge-sensor-sweep`
# will match the number of entries given here. 
captures:
  - center_frequency: 3750e6 # Hz
    analysis_bandwidth: 100e6 # Hz
    sample_rate: 153.6e6 # Hz
    gain: -10 # dB

  - center_frequency: 3830e6 # Hz
    analysis_bandwidth: 60e6 # Hz
    sample_rate: 92.16e6 # Hz
    gain: -10 # dB

  - center_frequency: 3900e6 # Hz
    analysis_bandwidth: 80e6 # Hz
    sample_rate: 122.88e6 # Hz
    gain: -10 # dB

  - center_frequency: 3960e6 # Hz
    sample_rate: 61.44e6 # Hz
    analysis_bandwidth: 40e6 # Hz
    gain: -10 # dB


# Specify the output analyses performed for each capture.
# - Each analysis key name corresponds with a function
#   * These are decorated by @expose_in_yaml in files in src/channel_analysis/factory
#   * The parameters specified here are passed in as keyword arguments in this function
# - The xarray.Dataset output from this sweep will include a data variable
#   matching the name of each of these analysis
channel_analysis:

    # ccdf evaluated on channel power in the time domain
    channel_power_ccdf:
        # binning is performed on the power axis to allow aggregation across captures
        power_low: -40 # dBm
        power_high: 15 # dBm
        power_resolution: 0.25

    # a cyclic analysis of total power in the time domain 
    cyclic_channel_power:
        cyclic_period: 10e-3
        cyclic_statistics:
        # any of "min", "mean", "max", or a quantile number 
        - min
        - mean
        - max
        detector_period: 1.6666666666666667e-05
        power_detectors:
        - rms
        - peak

    # a persistence spectrum evaluated along the spectrogram
    persistence_spectrum:
        # a list of statistics to apply across the frequency axis
        # 'min', 'max' (or equivalent 'peak'), 'mean' (or equivalent 'rms'), or a quantile number
        persistence_statistics:
        - mean
        - 0.5
        - 0.75
        - 0.9
        - 0.95
        - 0.99
        - 0.999
        - max

        # the step size in the frequency domain (Hz) 
        frequency_resolution: 15000

        # the fractional overlap in the STFT.
        # (Examples: 0: no overlap, 0.5: 50% overlap)
        fractional_overlap: 0.

        # the spectrum analysis window to apply to the FFT
        window:
            - dpss
            - 3.87638403 # for enbw:resolution == 2:1

    # channel power vs time
    power_time_series:
        # time bin size
        detector_period: 0.0005

        # list of statistics to evaluate in each detector time bin:
        # 'min', 'max' (or equivalent 'peak'), 'mean' (or equivalent 'rms'), or a quantile number
        power_detectors:
        - rms
        - peak

    # cyclic autocorrelation function for cellular OFDM cyclic prefixes
    cellular_cyclic_autocorrelation:
        # evaluate for the following cellular SCS
        subcarrier_spacings:
        - 15e3
        - 30e3
        - 60e3

        # the evaluation can be expensive; limit to this number of frames
        frame_limit: 2

        # if true, return a correlation; otherwise, return a covariance (power)
        normalize: true

    # save a clipping of the received IQ waveform
    iq_waveform:
        start_time_sec: 0
        stop_time_sec: 0.1